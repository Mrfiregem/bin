#!/usr/bin/env bash
tab=$'\t'
fzf_args=(
  "--delimiter=${tab}"
  '--with-nth=1,2'
  '--cycle'
  '--header=Flatpak Installer'
  '--preview=printf "%-8s: %s\n" package {1} app-id {3} version {4} branch {5} branch {6}'
  '--preview-label=Package Information'
  '--preview-window=top,5'
)

# If no query provided from cli, ask for input
if [[ -z $1 ]]; then
  read -rp 'Search: ' -a query
else
  query=("$@")
fi

mapfile -t pkg_info < <(flatpak search -- "${query[@]}" |
  fzf "${fzf_args[@]}" |
  awk -v 'FS=\t' -v 'OFS=\n' '{ print $6, $3 "//" $5 }')

if [[ -z ${pkg_info[*]} ]]; then
  echo "No program selected."
  exit 0
fi

exec flatpak install -- "${pkg_info[0]}" "${pkg_info[1]}"
